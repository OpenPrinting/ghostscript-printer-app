name: Pack and Publish OCI Image to Docker Registry and GitHub Packages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      workflow_choice:
        description: "Choose Release Channel"
        required: true
        default: "edge"
        type: choice
        options:
          - edge
          - stable
          - both
  workflow_run:
    workflows: ["Push new tag update to stable branch"]
    types:
      - completed

jobs:
  build-rock:
    strategy:
      matrix:
        include:
        - arch: 'amd64'
          runner: ubuntu-22.04
        - arch: 'arm64'
          runner: ubuntu-22.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Pack with Rockcraft
        uses: canonical/craft-actions/rockcraft-pack@main
        id: rockcraft

      - name: Upload Rock Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cups-rock-${{ matrix.arch }}
          path: ${{ steps.rockcraft.outputs.rock }}

  publish-rock:
    needs: build-rock
    if: github.ref_name == 'main' || github.ref_name == 'master'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Rock Artifact
        uses: actions/download-artifact@v4
        with:
          pattern: cups-rock-*
          merge-multiple: true

      - name: Install Dependencies
        run: |
          sudo snap install rockcraft --classic
          sudo snap install docker
          sudo snap install yq

      - name: Ensure Docker Daemon is Running
        run: |
          sudo systemctl start docker
          sudo systemctl enable docker
          sudo systemctl is-active --quiet docker || sudo systemctl start docker

      # - name: Log in to Docker Hub
      #   uses: docker/login-action@v3.2.0
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to GitHub Packages
        uses: docker/login-action@v3.2.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image (Edge & Latest Channel)
        if: github.event.inputs.workflow_choice == 'edge' || github.event.inputs.workflow_choice == 'both' || github.event_name == 'push' || github.event_name == 'workflow_run'
        env:
          USERNAME: ${{ secrets.DOCKER_USERNAME }}
          ORG: ${{ github.repository_owner }}
        run: |
          IMAGE="$(yq '.name' rockcraft.yaml)"
          VERSION="$(yq '.version' rockcraft.yaml)"
          ORG_NAME=$(echo "${ORG}" | tr '[:upper:]' '[:lower:]')
          GITHUB_IMAGE="ghcr.io/${ORG_NAME}/${IMAGE}"
          #declare -a DOCKER_MANIFESTS=()
          declare -a GITHUB_MANIFESTS=()
          # Upload each rock to the container registry
          for rock in *.rock; do
            echo "Create container from ${rock}"
            ARCH=$(rockcraft.skopeo --insecure-policy inspect "oci-archive:${rock}" --format "{{ .Architecture }}")
            echo "Architecture: ${ARCH}"
            rockcraft.skopeo --insecure-policy copy oci-archive:${rock} "docker-daemon:${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-edge"
            # Push to Docker Hub
            # docker tag ${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-edge ${USERNAME}:${VERSION}-${ARCH}-edge
            # docker push ${USERNAME}/${IMAGE}:${VERSION}-${ARCH}-edge
            # DOCKER_MANIFESTS+=("${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-edge")
            # Push to GitHub Packages
            docker tag ${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-edge ${GITHUB_IMAGE}:${VERSION}-${ARCH}-edge
            docker push ${GITHUB_IMAGE}:${VERSION}-${ARCH}-edge
            GITHUB_MANIFESTS+=("${GITHUB_IMAGE}:${VERSION}-${ARCH}-edge")
          done

          # Create and upload a multi-arch manifest for Docker Hub
          # echo "create multi-arch container from: ${DOCKER_MANIFESTS[@]}"
          # docker manifest create ${ORG_NAME}/${IMAGE}:${VERSION}-edge ${DOCKER_MANIFESTS[@]}
          # Push to Docker Hub
          # docker tag ${ORG_NAME}/${IMAGE}:${VERSION}-edge ${USERNAME}:${VERSION}-edge
          # docker push ${USERNAME}/${IMAGE}:${VERSION}-edge
          # docker tag ${USERNAME}/${IMAGE}:${VERSION}-edge ${USERNAME}/${IMAGE}:latest
          # docker push ${USERNAME}/${IMAGE}:latest

          # Create and upload a multi-arch manifest for Github Packages
          echo "create multi-arch container from: ${GITHUB_MANIFESTS[@]}"
          docker manifest create ${GITHUB_IMAGE}:${VERSION}-edge ${GITHUB_MANIFESTS[@]}
          docker manifest push ${GITHUB_IMAGE}:${VERSION}-edge
          docker manifest create ${GITHUB_IMAGE}:latest ${GITHUB_MANIFESTS[@]}
          docker manifest push ${GITHUB_IMAGE}:latest

      - name: Build and Push Docker Image (Stable Channel)
        if: github.event.inputs.workflow_choice == 'stable' || github.event.inputs.workflow_choice == 'both'
        env:
          USERNAME: ${{ secrets.DOCKER_USERNAME }}
          ORG: ${{ github.repository_owner }}
        run: |
            IMAGE="$(yq '.name' rockcraft.yaml)"
            VERSION="$(yq '.version' rockcraft.yaml)"
            ORG_NAME=$(echo "${ORG}" | tr '[:upper:]' '[:lower:]')
            GITHUB_IMAGE="ghcr.io/${ORG_NAME}/${IMAGE}"
            #declare -a DOCKER_MANIFESTS=()
            declare -a GITHUB_MANIFESTS=()
            # Upload each rock to the container registry
            for rock in *.rock; do
              echo "Create container from ${rock}"
              ARCH=$(rockcraft.skopeo --insecure-policy inspect "oci-archive:${rock}" --format "{{ .Architecture }}")
              echo "Architecture: ${ARCH}"
              rockcraft.skopeo --insecure-policy copy oci-archive:${rock} "docker-daemon:${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-stable"
              # Push to Docker Hub
              # docker tag ${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-stable ${USERNAME}:${VERSION}-${ARCH}-stable
              # docker push ${USERNAME}/${IMAGE}:${VERSION}-${ARCH}-stable
              # DOCKER_MANIFESTS+=("${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-stable")
              # Push to GitHub Packages
              docker tag ${ORG_NAME}/${IMAGE}:${VERSION}-${ARCH}-stable ${GITHUB_IMAGE}:${VERSION}-${ARCH}-stable
              docker push ${GITHUB_IMAGE}:${VERSION}-${ARCH}-stable
              GITHUB_MANIFESTS+=("${GITHUB_IMAGE}:${VERSION}-${ARCH}-stable")
            done

            # Create and upload a multi-arch manifest for Docker Hub
            # echo "create multi-arch container from: ${DOCKER_MANIFESTS[@]}"
            # docker manifest create ${ORG_NAME}/${IMAGE}:${VERSION}-stable ${DOCKER_MANIFESTS[@]}
            # docker manifest push ${ORG_NAME}/${IMAGE}:${VERSION}-stable

            # Create and upload a multi-arch manifest for Github Packages
            echo "create multi-arch container from: ${GITHUB_MANIFESTS[@]}"
            docker manifest create ${GITHUB_IMAGE}:${VERSION}-stable ${GITHUB_MANIFESTS[@]}
            docker manifest push ${GITHUB_IMAGE}:${VERSION}-stable
